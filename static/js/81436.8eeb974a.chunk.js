"use strict";(self.webpackChunkimage_editor=self.webpackChunkimage_editor||[]).push([[81436],{81436:(t,e,n)=>{n.r(e),n.d(e,{connectSmartWallet:()=>Q,disconnectSmartWallet:()=>Z,isSmartWallet:()=>q,personalAccountToSmartAccountMap:()=>K});var a=n(90638),r=n(54235),s=n(1578),i=n(1144),o=n(69212),c=n(40886);function u(t){if(["string","number"].includes(typeof t)&&!Number.isInteger(Number(t)))throw new Error("Expected value to be an integer to convert to a bigint, got ".concat(t," of type ").concat(typeof t));return t instanceof Uint8Array?BigInt((0,c.EY)(t)):BigInt(t)}var d=n(53135),l=n(31784),p=n(13446);const m=50000n,y=t=>{const e=function(t){const{gas:e,nonce:n,to:a,from:r,value:s,maxFeePerGas:i,maxPriorityFeePerGas:o,paymaster:c,paymasterInput:u,gasPerPubdata:d,data:l}=t;return{txType:113n,from:BigInt(r),to:a?BigInt(a):0n,gasLimit:null!==e&&void 0!==e?e:0n,gasPerPubdataByteLimit:null!==d&&void 0!==d?d:m,maxFeePerGas:null!==i&&void 0!==i?i:0n,maxPriorityFeePerGas:null!==o&&void 0!==o?o:0n,paymaster:c?BigInt(c):0n,nonce:n?BigInt(n):0n,value:null!==s&&void 0!==s?s:0n,data:l||"0x0",factoryDeps:[],paymasterInput:u||"0x"}}(t);return{domain:{name:"zkSync",version:"2",chainId:t.chainId},types:{Transaction:[{name:"txType",type:"uint256"},{name:"from",type:"uint256"},{name:"to",type:"uint256"},{name:"gasLimit",type:"uint256"},{name:"gasPerPubdataByteLimit",type:"uint256"},{name:"maxFeePerGas",type:"uint256"},{name:"maxPriorityFeePerGas",type:"uint256"},{name:"paymaster",type:"uint256"},{name:"nonce",type:"uint256"},{name:"value",type:"uint256"},{name:"data",type:"bytes"},{name:"factoryDeps",type:"bytes32[]"},{name:"paymasterInput",type:"bytes"}]},primaryType:"Transaction",message:e}};async function v(t){const{account:e,eip712Transaction:n,chainId:a}=t,r=y(n),s=await e.signTypedData({...r});return function(t){const{chainId:e,gas:n,nonce:a,to:r,from:s,value:o,maxFeePerGas:u,maxPriorityFeePerGas:d,customSignature:l,factoryDeps:p,paymaster:y,paymasterInput:v,gasPerPubdata:h,data:g}=t,f=[a?(0,c.nj)(a):"0x",d?(0,c.nj)(d):"0x",u?(0,c.nj)(u):"0x",n?(0,c.nj)(n):"0x",null!==r&&void 0!==r?r:"0x",o?(0,c.nj)(o):"0x",null!==g&&void 0!==g?g:"0x0",(0,c.nj)(e),(0,c.nj)(""),(0,c.nj)(""),(0,c.nj)(e),null!==s&&void 0!==s?s:"0x",h?(0,c.nj)(h):(0,c.nj)(m),null!==p&&void 0!==p?p:[],null!==l&&void 0!==l?l:"0x",y&&v?[y,v]:[]];return w=["0x71",(0,i.EQ)(f)],"0x".concat(w.reduce(((t,e)=>t+e.replace("0x","")),""));var w}({...n,chainId:a,customSignature:s})}async function h(t){const{account:e,transaction:n}=t;let[a,r,s,i,m,y,v]=await Promise.all([(0,l.encode)(n),(0,d.r)(n.to),(0,d.r)(n.value),(0,d.r)(n.gas),(0,d.r)(n.maxFeePerGas),(0,d.r)(n.maxPriorityFeePerGas),(0,d.r)(n.eip712).then((t=>null===t||void 0===t?void 0:t.gasPerPubdata))]);if(!i||!m||!y){const t=(0,o.getRpcClient)(n),d=await t({method:"zks_estimateFee",params:[{from:e.address,to:r,data:a,value:s?(0,c.cK)(s):void 0}]});i=u(d.gas_limit);m=2n*u(d.max_fee_per_gas),y=u(d.max_priority_fee_per_gas)||1n,v=u(d.gas_per_pubdata_limit)}return{...await(0,p.$)({transaction:{...n,gas:i,maxFeePerGas:m,maxPriorityFeePerGas:y},from:e.address}),...n.eip712,gasPerPubdata:v,from:e.address}}var g=n(11302),f=n(13531),w=n(23158);var x=n(34425),P=n(75485),G=n(54928);function b(){return function(t){const{signature:e}=t;let n;var a;return n=(a=e)&&"object"===typeof a&&"type"in a&&"event"===a.type?e:(0,x.$)(e),{abiEvent:n,hash:(0,P.k)(n),topics:(0,G.R)({abi:[n],args:t.filters})}}({signature:"event UserOperationRevertReason(bytes32 indexed userOpHash, address indexed sender, uint256 nonce, bytes revertReason)",filters:arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}})}var A=n(3692),T=n(49343),I=n(34185),O=n(51546),C=n(65289);const L=()=>{const t=BigInt(Math.floor(4294967296*Math.random())),e=BigInt(Math.floor(4294967296*Math.random())),n=BigInt(Math.floor(4294967296*Math.random())),a=BigInt(Math.floor(4294967296*Math.random())),r=BigInt(Math.floor(4294967296*Math.random())),s=BigInt(Math.floor(4294967296*Math.random()));return t<<BigInt(160)|e<<BigInt(128)|n<<BigInt(96)|a<<BigInt(64)|r<<BigInt(32)|s},D=()=>BigInt((0,O.xW)([(0,c.cK)(L()),"0x0000000000000000"]));function U(t){return Object.fromEntries(Object.entries(t).map((t=>{let[e,n]=t;return[e,(0,C.q)(n)?n:(0,c.nj)(n)]})))}async function B(t){var e,n;const a=await F({...t,operation:"eth_estimateUserOperationGas",params:[U(t.userOp),null!==(e=null===(n=t.options.overrides)||void 0===n?void 0:n.entrypointAddress)&&void 0!==e?e:I.uh]});return{preVerificationGas:(0,c.uU)(a.preVerificationGas),verificationGas:(0,c.uU)(a.verificationGas),verificationGasLimit:(0,c.uU)(a.verificationGasLimit),callGasLimit:(0,c.uU)(a.callGasLimit)+I.L8}}async function M(t){const e=await F({...t,operation:"eth_getUserOperationReceipt",params:[t.userOpHash]});if(e){if(!1===e.success){var n;const t=null===(n=function(t){const{logs:e,events:n,strict:a}=t;return(0,w.p)({logs:e,abi:n.map((t=>t.abiEvent)),strict:a})}({events:[b()],logs:e.logs})[0])||void 0===n||null===(n=n.args)||void 0===n?void 0:n.revertReason;if(!t)throw new Error("UserOp failed at txHash: ".concat(e.transactionHash));const a=(0,f.W)({data:t});throw new Error("UserOp failed with reason: '".concat(a.args.join(","),"' at txHash: ").concat(e.transactionHash))}return e.receipt}}async function F(t){var e,n;const{options:a,operation:r,params:s}=t;I.Oi&&console.debug(">>> sending ".concat(r," with payload:"),s);const i=null!==(e=null===(n=a.overrides)||void 0===n?void 0:n.bundlerUrl)&&void 0!==e?e:(0,I.RZ)(a.chain),o=(0,A.KI)(a.client),c=await o(i,{method:"POST",headers:{"Content-Type":"application/json"},body:(0,T.A)({jsonrpc:"2.0",id:1,method:r,params:s})}),u=await c.json();if(!c.ok||u.error){let t=u.error||c.statusText;"object"===typeof t&&(t=JSON.stringify(t));const e=u.code||"UNKNOWN";throw new Error("".concat(r," error: ").concat(t,"\nStatus: ").concat(c.status,"\nCode: ").concat(e))}return I.Oi&&console.debug("<<< ".concat(r," result:"),u),u.result}var j=n(36887),_=n(60301);var S=n(12927),k=n(96836),E=n(27499),H=n(14060),V=n(80929);async function R(t){var e,n,a,r;const{userOp:s,options:i}=t;var o;if(null!==(e=i.overrides)&&void 0!==e&&e.paymaster)return null===(o=i.overrides)||void 0===o?void 0:o.paymaster(s);const u=i.client,d=(0,I.lI)(i.chain),l=null!==(n=null===(a=i.overrides)||void 0===a?void 0:a.entrypointAddress)&&void 0!==n?n:I.uh,p=(0,A.KI)(u),m=await p(d,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({jsonrpc:"2.0",id:1,method:"pm_sponsorUserOperation",params:[U(s),l]})}),y=await m.json();if(!m.ok){const t=y.error||m.statusText,e=y.code||"UNKNOWN";throw new Error("Paymaster error: ".concat(t,"\nStatus: ").concat(m.status,"\nCode: ").concat(e))}if(I.Oi&&console.debug("Paymaster result:",y),y.result)return"string"===typeof y.result?{paymasterAndData:y.result}:{paymasterAndData:y.result.paymasterAndData,verificationGasLimit:y.result.verificationGasLimit?(0,c.uU)(y.result.verificationGasLimit):void 0,preVerificationGas:y.result.preVerificationGas?(0,c.uU)(y.result.preVerificationGas):void 0,callGasLimit:y.result.callGasLimit?(0,c.uU)(y.result.callGasLimit):void 0};const v=(null===(r=y.error)||void 0===r?void 0:r.message)||y.error||m.statusText||"unknown error";throw new Error("Paymaster error from ".concat(d,": ").concat(v))}async function W(t){var e,n;const{executeTx:a,options:r}=t,s=await(0,E.isContractDeployed)(r.accountContract)?"0x":await async function(t){const{factoryContract:e}=t,n=function(t){var e,n,a;const{factoryContract:r,options:s}=t;return null!==(e=s.overrides)&&void 0!==e&&e.createAccount?s.overrides.createAccount(r):(0,j.m)({contract:r,method:"function createAccount(address, bytes) returns (address)",params:[s.personalAccount.address,(0,c.i3)(null!==(n=null===(a=s.overrides)||void 0===a?void 0:a.accountSalt)&&void 0!==n?n:"")]})}({factoryContract:e,options:t});return(0,O.xW)([e.address,await(0,l.encode)(n)])}(r),i=await(0,l.encode)(a);let{maxFeePerGas:o,maxPriorityFeePerGas:u}=a;const p=null!==(e=null===(n=r.overrides)||void 0===n?void 0:n.bundlerUrl)&&void 0!==e?e:(0,I.RZ)(r.chain);if((0,A.Lj)(p)){const t=await async function(t){const e=await F({...t,operation:"thirdweb_getUserOperationGasPrice",params:[]});return{maxPriorityFeePerGas:(0,c.uU)(e.maxPriorityFeePerGas),maxFeePerGas:(0,c.uU)(e.maxFeePerGas)}}({options:r});o=t.maxFeePerGas,u=t.maxPriorityFeePerGas}else{const[t,e]=await Promise.all([(0,d.r)(o),(0,d.r)(u)]);if(t&&e)o=t,u=e;else{var m,y;const n=await(0,S.G)(r.client,r.chain);u=null!==(m=null!==e&&void 0!==e?e:n.maxPriorityFeePerGas)&&void 0!==m?m:0n,o=null!==(y=null!==t&&void 0!==t?t:n.maxFeePerGas)&&void 0!==y?y:0n}}const v=D(),h={sender:r.accountContract.address,nonce:v,initCode:s,callData:i,maxFeePerGas:o,maxPriorityFeePerGas:u,callGasLimit:0n,verificationGasLimit:0n,preVerificationGas:0n,paymasterAndData:"0x",signature:I.km};if(r.sponsorGas){const t=await R({userOp:h,options:r}),e=t.paymasterAndData;if(e&&"0x"!==e&&(h.paymasterAndData=e),t.callGasLimit&&t.verificationGasLimit&&t.preVerificationGas)h.callGasLimit=t.callGasLimit,h.verificationGasLimit=t.verificationGasLimit,h.preVerificationGas=t.preVerificationGas;else{const t=await B({userOp:h,options:r});if(h.callGasLimit=t.callGasLimit,h.verificationGasLimit=t.verificationGasLimit,h.preVerificationGas=t.preVerificationGas,e&&"0x"!==e){const t=await R({userOp:h,options:r});t.paymasterAndData&&"0x"!==t.paymasterAndData&&(h.paymasterAndData=t.paymasterAndData)}}}else{const t=await B({userOp:h,options:r});h.callGasLimit=t.callGasLimit,h.verificationGasLimit=t.verificationGasLimit,h.preVerificationGas=t.preVerificationGas}return{...h,signature:"0x"}}async function N(t){var e;const{userOp:n,options:a}=t,r=function(t){const{userOp:e,entryPoint:n,chainId:a}=t,r=(0,V.S)(e.initCode),s=(0,V.S)(e.callData),i=(0,V.S)(e.paymasterAndData),o=(0,k.encodeAbiParameters)([{type:"address"},{type:"uint256"},{type:"bytes32"},{type:"bytes32"},{type:"uint256"},{type:"uint256"},{type:"uint256"},{type:"uint256"},{type:"uint256"},{type:"bytes32"}],[e.sender,e.nonce,r,s,e.callGasLimit,e.verificationGasLimit,e.preVerificationGas,e.maxFeePerGas,e.maxPriorityFeePerGas,i]),c=(0,k.encodeAbiParameters)([{type:"bytes32"},{type:"address"},{type:"uint256"}],[(0,V.S)(o),n,BigInt(a)]);return(0,V.S)(c)}({userOp:n,entryPoint:(null===(e=a.overrides)||void 0===e?void 0:e.entrypointAddress)||I.uh,chainId:a.chain.id});if(a.personalAccount.signMessage){const t=await a.personalAccount.signMessage({message:{raw:(0,H.aT)(r)}});return{...n,signature:t}}throw new Error("signMessage not implemented in signingAccount")}function q(t){return"smart"===t.id}const K=new WeakMap,z=new WeakMap;async function Q(t,e,r){var i;const{personalAccount:o,client:u,chain:d}=e;if(!o)throw new Error("Personal wallet does not have an account");const l=r,p=null!==(i=l.factoryAddress)&&void 0!==i?i:I.zk,m=null!==d&&void 0!==d?d:l.chain,y="gasless"in l?l.gasless:l.sponsorGas;if(function(t){return 324===t.id||300===t.id||302===t.id}(m))return[J({creationOptions:r,connectionOptions:e,chain:m,sponsorGas:y}),m];const v=(0,s.P)({client:u,address:p,chain:m}),h=await async function(t,e){var n,a,r,s;if(null!==(n=e.overrides)&&void 0!==n&&n.predictAddress)return e.overrides.predictAddress(t);if(null!==(a=e.overrides)&&void 0!==a&&a.accountAddress)return e.overrides.accountAddress;const i=e.personalAccountAddress;if(!i)throw new Error("Account address is required to predict the smart wallet address.");const o=(0,c.i3)(null!==(r=null===(s=e.overrides)||void 0===s?void 0:s.accountSalt)&&void 0!==r?r:"");return(0,_.readContract)({contract:t,method:"function getAddress(address, bytes) returns (address)",params:[i,o]})}(v,{personalAccountAddress:o.address,...l}).then((t=>t)).catch((t=>{throw new Error("Failed to get account address with factory contract ".concat(v.address," on chain ID ").concat(m.id,". Are you on the right chain?"),{cause:t})})),f=(0,s.P)({client:u,address:h,chain:m}),w=await async function(t){const{accountContract:e}=t,r={address:e.address,async sendTransaction(n){const a=function(t){var e;const{accountContract:n,options:a,transaction:r}=t;return null!==(e=a.overrides)&&void 0!==e&&e.execute?a.overrides.execute(n,r):(0,j.m)({contract:n,method:"function execute(address, uint256, bytes)",params:[r.to||"",r.value||0n,r.data||"0x"]})}({accountContract:e,options:t,transaction:n});return Y({executeTx:a,options:t})},async sendBatchTransaction(n){const a=function(t){var e;const{accountContract:n,options:a,transactions:r}=t;return null!==(e=a.overrides)&&void 0!==e&&e.executeBatch?a.overrides.executeBatch(n,r):(0,j.m)({contract:n,method:"function executeBatch(address[], uint256[], bytes[])",params:[r.map((t=>t.to||"")),r.map((t=>t.value||0n)),r.map((t=>t.data||"0x"))]})}({accountContract:e,options:t,transactions:n});return Y({executeTx:a,options:t})},async signMessage(a){let{message:s}=a;const[{isContractDeployed:i},{readContract:o},{encodeAbiParameters:c},{hashMessage:u},{checkContractWalletSignature:d}]=await Promise.all([Promise.resolve().then(n.bind(n,27499)),Promise.resolve().then(n.bind(n,60301)),Promise.resolve().then(n.bind(n,96836)),n.e(94821).then(n.bind(n,94821)),n.e(46055).then(n.bind(n,46055))]);await i(e)||(console.log("Account contract not deployed yet. Deploying account before signing message"),await $({options:t,account:r,accountContract:e}));const l=u(s);let p,m=!1;try{await o({contract:e,method:"function getMessageHash(bytes32 _hash) public view returns (bytes32)",params:[l]}),m=!0}catch(y){}if(m){const n=c([{type:"bytes32"}],[l]);p=await t.personalAccount.signTypedData({domain:{name:"Account",version:"1",chainId:t.chain.id,verifyingContract:e.address},primaryType:"AccountMessage",types:{AccountMessage:[{name:"message",type:"bytes"}]},message:{message:n}})}else p=await t.personalAccount.signMessage({message:s});if(await d({contract:e,message:s,signature:p}))return p;throw new Error("Unable to verify signature on smart account, please make sure the smart account is deployed and the signature is valid.")},async signTypedData(s){var i,o;const c=(0,g.y)(s),[{isContractDeployed:u},{readContract:d},{encodeAbiParameters:l},{checkContractWalletSignedTypedData:p}]=await Promise.all([Promise.resolve().then(n.bind(n,27499)),Promise.resolve().then(n.bind(n,60301)),Promise.resolve().then(n.bind(n,96836)),n.e(6281).then(n.bind(n,6281))]);if((null===(i=c.domain)||void 0===i||null===(i=i.verifyingContract)||void 0===i?void 0:i.toLowerCase())===(null===(o=e.address)||void 0===o?void 0:o.toLowerCase()))return t.personalAccount.signTypedData(c);await u(e)||(console.log("Account contract not deployed yet. Deploying account before signing message"),await $({options:t,account:r,accountContract:e}));const m=(0,a.Z)(c);let y,v=!1;try{await d({contract:e,method:"function getMessageHash(bytes32 _hash) public view returns (bytes32)",params:[m]}),v=!0}catch(h){}if(v){const n=l([{type:"bytes32"}],[m]);y=await t.personalAccount.signTypedData({domain:{name:"Account",version:"1",chainId:t.chain.id,verifyingContract:e.address},primaryType:"AccountMessage",types:{AccountMessage:[{name:"message",type:"bytes"}]},message:{message:n}})}else y=await t.personalAccount.signTypedData(c);if(await p({contract:e,data:c,signature:y}))return y;throw new Error("Unable to verify signature on smart account, please make sure the smart account is deployed and the signature is valid.")},async onTransactionRequested(e){var n,a;return null===(n=(a=t.personalAccount).onTransactionRequested)||void 0===n?void 0:n.call(a,e)}};return r}({...l,chain:m,sponsorGas:y,personalAccount:o,accountContract:f,factoryContract:v,client:u});return K.set(o,t),z.set(t,o),[w,m]}async function Z(t){const e=z.get(t);e&&(K.delete(e),z.delete(t))}function J(t){const{creationOptions:e,connectionOptions:n,chain:a}=t,s={address:n.personalAccount.address,async sendTransaction(i){var o,c;const u={data:i.data,to:null!==(o=i.to)&&void 0!==o?o:void 0,value:null!==(c=i.value)&&void 0!==c?c:0n,chain:(0,r.Q4)(i.chainId),client:n.client};let d=await h({account:s,transaction:u});if(t.sponsorGas){const t=await async function(t){const e=await F({options:t.options,operation:"zk_paymasterData",params:[t.transaction]});return{paymaster:e.paymaster,paymasterInput:e.paymasterInput}}({options:{client:n.client,overrides:e.overrides,chain:a},transaction:d});d={...d,...t}}const l=await v({account:s,chainId:a.id,eip712Transaction:d}),p=await async function(t){return{transactionHash:(await F({options:t.options,operation:"zk_broadcastTransaction",params:[{...t.transaction,signedTransaction:t.signedTransaction}]})).transactionHash}}({options:{client:n.client,overrides:e.overrides,chain:a},transaction:d,signedTransaction:l});return{transactionHash:p.transactionHash,client:n.client,chain:a}},async signMessage(t){let{message:e}=t;return n.personalAccount.signMessage({message:e})},async signTypedData(t){const e=(0,g.y)(t);return n.personalAccount.signTypedData(e)},async onTransactionRequested(t){var e,a;return null===(e=(a=n.personalAccount).onTransactionRequested)||void 0===e?void 0:e.call(a,t)}};return s}async function $(t){const{options:e,account:a,accountContract:r}=t,[{sendTransaction:s},{prepareTransaction:i}]=await Promise.all([Promise.resolve().then(n.bind(n,70793)),Promise.resolve().then(n.bind(n,30110))]),o=i({client:e.client,chain:e.chain,to:r.address,value:0n,gas:50000n});return await s({transaction:o,account:a})}async function Y(t){const{executeTx:e,options:n}=t,a=await W({executeTx:e,options:n}),r=await N({options:n,userOp:a}),s=await async function(t){var e,n;return F({...t,operation:"eth_sendUserOperation",params:[U(t.userOp),null!==(e=null===(n=t.options.overrides)||void 0===n?void 0:n.entrypointAddress)&&void 0!==e?e:I.uh]})}({options:n,userOp:r}),i=await async function(t){const{options:e,userOpHash:n}=t,a=12e4,r=1e3,s=Date.now()+a;for(;Date.now()<s;){const t=await M({options:e,userOpHash:n});if(t)return t;await new Promise((t=>setTimeout(t,r)))}throw new Error("Timeout waiting for userOp to be mined")}({options:n,userOpHash:s});return{client:n.client,chain:n.chain,transactionHash:i.transactionHash}}},1144:(t,e,n)=>{n.d(e,{EQ:()=>o});var a=n(86788),r=n(44449),s=n(44357),i=n(999);function o(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"hex";const n=c(t),a=(0,r.l)(new Uint8Array(n.length));return n.encode(a),"hex"===e?(0,i.My)(a.bytes):a.bytes}function c(t){return Array.isArray(t)?function(t){const e=t.reduce(((t,e)=>t+e.length),0),n=u(e);return{length:e<=55?1+e:1+n+e,encode(a){e<=55?a.pushByte(192+e):(a.pushByte(247+n),1===n?a.pushUint8(e):2===n?a.pushUint16(e):3===n?a.pushUint24(e):a.pushUint32(e));for(const{encode:e}of t)e(a)}}}(t.map((t=>c(t)))):function(t){const e="string"===typeof t?(0,s.aT)(t):t,n=u(e.length),a=1===e.length&&e[0]<128?1:e.length<=55?1+e.length:1+n+e.length;return{length:a,encode(t){1===e.length&&e[0]<128?t.pushBytes(e):e.length<=55?(t.pushByte(128+e.length),t.pushBytes(e)):(t.pushByte(183+n),1===n?t.pushUint8(e.length):2===n?t.pushUint16(e.length):3===n?t.pushUint24(e.length):t.pushUint32(e.length),t.pushBytes(e))}}}(t)}function u(t){if(t<256)return 1;if(t<65536)return 2;if(t<2**24)return 3;if(t<2**32)return 4;throw new a.C("Length is too large.")}}}]);
//# sourceMappingURL=81436.8eeb974a.chunk.js.map